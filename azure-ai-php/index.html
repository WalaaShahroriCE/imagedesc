<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>مولد أوصاف المنتجات بالذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .upload-area { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .upload-area:hover { border-color: #3b82f6; background-color: #f8fafc; }
        .upload-area.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .step-indicator { position: relative; }
        .step-indicator::after { content: ''; position: absolute; top: 50%; left: 100%; width: 50px; height: 2px; background: #e5e7eb; transform: translateY(-50%); }
        .step-indicator.active::after { background: #3b82f6; }
        .step-indicator:last-child::after { display: none; }
        .description-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px 0; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">🛍️ مولد أوصاف المنتجات</h1>
      <p class="text-gray-600 text-lg">ارفع صورة منتج واحصل على أوصاف تسويقية احترافية بالذكاء الاصطناعي</p>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
      <div id="uploadArea" class="upload-area rounded-xl p-12 text-center cursor-pointer">
        <div id="uploadContent">
          <div class="text-6xl mb-4">📸</div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">اسحب صورة المنتج هنا أو انقر للاختيار</h3>
          <p class="text-gray-500 mb-4">يدعم JPG, PNG, WebP حتى 10MB</p>
          <button id="chooseBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
            اختر صورة المنتج
          </button>
        </div>
        <input type="file" id="fileInput" accept="image/*" class="hidden">
      </div>
    </div>

    <div id="resultsSection" class="hidden">
      <div class="grid lg:grid-cols-3 gap-8">
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">🖼️ صورة المنتج</h3>
          <div class="border-2 border-gray-200 rounded-xl overflow-hidden">
            <img id="imagePreview" class="w-full h-64 object-cover" alt="معاينة المنتج">
          </div>
          <div class="mt-4 text-sm text-gray-600"><p id="imageInfo"></p></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">🔍 التحليل السريع</h3>
          <div id="shortAnalysis" class="space-y-4"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">✨ الأوصاف التسويقية</h3>
          <div id="marketingDescriptions" class="space-y-4"></div>
        </div>
      </div>

      <div class="text-center mt-8 space-x-4 space-x-reverse">
        <button id="copyAllBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
          📋 نسخ جميع الأوصاف
        </button>
        <button id="regenerateBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
          🔄 إنشاء أوصاف جديدة
        </button>
        <button id="newProductBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
          📸 منتج جديد
        </button>
      </div>
    </div>
  </div>

<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const chooseBtn = document.getElementById('chooseBtn');
const resultsSection = document.getElementById('resultsSection');
const imagePreview = document.getElementById('imagePreview');
const imageInfo = document.getElementById('imageInfo');
const shortAnalysis = document.getElementById('shortAnalysis');
const marketingDescriptions = document.getElementById('marketingDescriptions');
const copyAllBtn = document.getElementById('copyAllBtn');
const regenerateBtn = document.getElementById('regenerateBtn');
const newProductBtn = document.getElementById('newProductBtn');

let currentShortDescription = '';
let currentMarketingDescriptions = [];

chooseBtn.addEventListener('click', () => fileInput.click());

uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length > 0) handleFile(files[0]);
});

fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });

function handleFile(file) {
  if (!file.type.startsWith('image/')) { alert('يرجى اختيار ملف صورة صحيح'); return; }
  if (file.size > 10 * 1024 * 1024) { alert('حجم الملف كبير جداً. يرجى اختيار صورة أصغر من 10MB'); return; }

  const reader = new FileReader();
  reader.onload = (e) => {
    const dataUrl = e.target.result;
    imagePreview.src = dataUrl;
    imageInfo.textContent = `اسم الملف: ${file.name} | الحجم: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
    resultsSection.classList.remove('hidden');
    getAnalysis(dataUrl);
  };
  reader.readAsDataURL(file);
}

async function getAnalysis(imageData) {
  showLoadingState('shortAnalysis', 'تحليل المنتج...');
  showLoadingState('marketingDescriptions', 'إنشاء الأوصاف التسويقية...');

  try {
    const resp = await fetch('backend.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imageData })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(txt || 'حدث خطأ في السيرفر');
    }

    const data = await resp.json();
    // Expecting Azure response structure with choices[0].message.content for short description and/or a combined response
    // We'll handle two flows: if backend returns final descriptions array or raw Azure reply.
    if (data.descriptions) {
      // our backend parsed descriptions
      currentShortDescription = data.short || '';
      currentMarketingDescriptions = data.descriptions || [];
      displayShortAnalysis(currentShortDescription);
      displayMarketingDescriptions(currentMarketingDescriptions);
    } else {
      // raw Azure response -> extract text
      const content = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
      currentShortDescription = content;
      currentMarketingDescriptions = content.split('\n').filter(Boolean).map(s => s.trim());
      displayShortAnalysis(currentShortDescription);
      displayMarketingDescriptions(currentMarketingDescriptions);
    }
  } catch (err) {
    console.error(err);
    displayError(err.message || 'خطأ غير معروف');
  }
}

function showLoadingState(elementId, message) {
  document.getElementById(elementId).innerHTML = `
    <div class="loading text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
      <p class="text-gray-600">${message}</p>
    </div>
  `;
}

function displayShortAnalysis(description) {
  shortAnalysis.innerHTML = `
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-r-4 border-blue-500">
      <h4 class="font-bold text-lg text-gray-800 mb-3 flex items-center">
        <span class="text-2xl ml-2">🎯</span> الوصف السريع
      </h4>
      <p class="text-xl font-semibold text-blue-700 mb-4">"${description}"</p>
      <div class="text-sm text-gray-600">
        <p>✅ تم التحليل بنجاح</p>
        <p>📝 ${description.split(' ').length} كلمات</p>
      </div>
    </div>
  `;
}

function displayMarketingDescriptions(descriptions) {
  const titles = ['🎯 وصف قصير وجذاب','⭐ وصف متوسط مع المميزات','🛒 وصف تفصيلي للمتجر','📢 وصف إعلاني مؤثر','📱 وصف لوسائل التواصل'];
  const colors = ['from-pink-500 to-rose-500','from-purple-500 to-indigo-500','from-green-500 to-teal-500','from-orange-500 to-red-500','from-blue-500 to-cyan-500'];
  let html = '';
  descriptions.forEach((desc, index) => {
    if (desc.trim()) {
      html += `
        <div class="description-card bg-gradient-to-r ${colors[index % colors.length]} mb-4">
          <h5 class="font-bold mb-2 flex items-center">${titles[index] || `📝 وصف ${index + 1}`}</h5>
          <p class="leading-relaxed mb-3">${desc}</p>
          <div class="flex justify-between items-center text-sm opacity-90">
            <span>${desc.split(' ').length} كلمة</span>
            <button onclick="copyDescription('${desc.replace(/'/g, "\\'")}', this)" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded transition-colors">📋 نسخ</button>
          </div>
        </div>
      `;
    }
  });
  marketingDescriptions.innerHTML = html;
}

function copyDescription(text, button) {
  navigator.clipboard.writeText(text).then(() => {
    const originalText = button.textContent;
    button.textContent = '✅ تم النسخ';
    button.classList.add('bg-green-500');
    setTimeout(() => { button.textContent = originalText; button.classList.remove('bg-green-500'); }, 2000);
  });
}

function displayError(message) {
  const errorHtml = `
    <div class="text-center py-8">
      <div class="text-4xl mb-4">❌</div>
      <h4 class="text-xl font-semibold text-red-600 mb-2">خطأ في المعالجة</h4>
      <p class="text-gray-600 mb-4">${message}</p>
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h5 class="font-semibold text-red-800 mb-2">💡 نصائح لحل المشكلة:</h5>
        <ul class="text-red-700 text-sm space-y-1 text-right">
          <li>• تأكد من ضبط ملف <strong>.env</strong> بالقيم الصحيحة</li>
          <li>• تحقق من اتصال السيرفر بالإنترنت</li>
          <li>• تأكد من وضوح صورة المنتج</li>
        </ul>
      </div>
    </div>
  `;
  shortAnalysis.innerHTML = errorHtml;
  marketingDescriptions.innerHTML = errorHtml;
}

// Copy all
copyAllBtn.addEventListener('click', () => {
  if (currentMarketingDescriptions.length > 0) {
    const allText = `الوصف السريع: ${currentShortDescription}

` + currentMarketingDescriptions.map((desc, index) => `${index+1}. ${desc}`).join('\n\n');
    navigator.clipboard.writeText(allText).then(() => {
      copyAllBtn.innerHTML = '✅ تم نسخ جميع الأوصاف!';
      copyAllBtn.classList.remove('bg-green-600','hover:bg-green-700');
      copyAllBtn.classList.add('bg-green-500');
      setTimeout(() => {
        copyAllBtn.innerHTML = '📋 نسخ جميع الأوصاف';
        copyAllBtn.classList.remove('bg-green-500');
        copyAllBtn.classList.add('bg-green-600','hover:bg-green-700');
      }, 3000);
    });
  }
});

// Regenerate
regenerateBtn.addEventListener('click', () => {
  if (currentShortDescription) {
    showLoadingState('marketingDescriptions', 'إنشاء أوصاف جديدة...');
    fetch('backend.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imageData: imagePreview.src, regenerate: true })
    }).then(r => r.json()).then(data => {
      if (data.descriptions) {
        currentMarketingDescriptions = data.descriptions;
        displayMarketingDescriptions(currentMarketingDescriptions);
      }
    }).catch(err => displayError(err.message || 'خطأ'));
  }
});

newProductBtn.addEventListener('click', () => {
  resultsSection.classList.add('hidden');
  fileInput.value = '';
  imagePreview.src = '';
  imageInfo.textContent = '';
  currentShortDescription = '';
  currentMarketingDescriptions = [];
});

</script>
</body>
</html>
